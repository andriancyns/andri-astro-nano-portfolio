---
import { languages, type Language } from '../i18n';

interface Props {
  currentLang: Language;
}

const { currentLang } = Astro.props;
---

<div class="language-switcher">
  <select 
    id="language-select" 
    class="bg-transparent text-sm border-none outline-none cursor-pointer"
    value={currentLang}
  >
    {Object.entries(languages).map(([code]) => (
      <option value={code} selected={code === currentLang}>
        {code.toUpperCase()}
      </option>
    ))}
  </select>
</div>

<script is:inline>
  function saveLanguagePreference(lang) {
    if (typeof window !== 'undefined') {
      localStorage.setItem('preferred-language', lang);
    }
  }

  function getLanguageFromURL() {
    if (typeof window === 'undefined') return null;
    
    const path = window.location.pathname;
    const segments = path.split('/').filter(Boolean);
    
    if (segments.length > 0 && ['en', 'id'].includes(segments[0])) {
      return segments[0];
    }
    
    return null;
  }

  function redirectToLanguage(targetLang) {
    if (typeof window === 'undefined') return;
    
    const currentPath = window.location.pathname;
    const currentLang = getLanguageFromURL();
    
    let newPath = currentPath;
    
    if (currentLang) {
      // Remove current language from path
      newPath = currentPath.replace(`/${currentLang}`, '') || '/';
    }
    
    // Add new language prefix (except for default language)
    if (targetLang !== 'id') {
      newPath = `/${targetLang}${newPath}`;
    }
    
    // Save preference and redirect
    saveLanguagePreference(targetLang);
    window.location.href = newPath;
  }
  
  const languageSelect = document.getElementById('language-select');
  
  if (languageSelect) {
    languageSelect.addEventListener('change', (e) => {
      const target = e.target;
      const newLang = target.value;
      redirectToLanguage(newLang);
    });
  }
</script>

<style>
  .language-switcher select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.25rem center;
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
    padding-right: 1.5rem;
  }
</style>