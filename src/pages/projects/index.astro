---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import ArrowCard from "@components/ArrowCard.astro";
import { PROJECTS } from "@consts";

type ProjectEntry = CollectionEntry<"projects">;

const projects = (await getCollection("projects"))
  .filter(project => !project.data.draft)
  .sort((a, b) => {
    const getStatusWeight = (entry: ProjectEntry) =>
      entry.data.status === "ongoing" ? 0 : 1;
    const statusDiff = getStatusWeight(a) - getStatusWeight(b);
    if (statusDiff !== 0) return statusDiff;
    return b.data.date.valueOf() - a.data.date.valueOf();
  });

const ongoingProjects: ProjectEntry[] = [];
const completedProjects: ProjectEntry[] = [];
for (const project of projects) {
  if (project.data.status === "ongoing") {
    ongoingProjects.push(project);
  } else {
    completedProjects.push(project);
  }
}

const groupedCompleted: Record<string, ProjectEntry[]> = {};
for (const project of completedProjects) {
  const year = String(project.data.date.getFullYear());
  if (!groupedCompleted[year]) groupedCompleted[year] = [];
  groupedCompleted[year].push(project);
}
const sortedYears = Object.keys(groupedCompleted).sort(
  (a, b) => parseInt(b) - parseInt(a)
);
---

<PageLayout title={PROJECTS.TITLE} description={PROJECTS.DESCRIPTION}>
  <Container>
    <div class="space-y-10">
      <div class="animate font-semibold text-black dark:text-white">
        Projects
      </div>
      <div class="animate flex flex-col gap-8">
        {ongoingProjects.length > 0 && (
          <section>
            <h2 class="text-xl font-bold mb-2">In Progress</h2>
            <ul class="flex flex-col gap-3 mb-4">
              {ongoingProjects.map((project) => (
                <li><ArrowCard entry={project} /></li>
              ))}
            </ul>
          </section>
        )}
        {sortedYears.map(year => (
          <section>
            <h2 class="text-xl font-bold mb-2">{year}</h2>
            <ul class="flex flex-col gap-3 mb-4">
              {groupedCompleted[year].map((project) => (
                <li><ArrowCard entry={project} /></li>
              ))}
            </ul>
          </section>
        ))}
      </div>
    </div>
  </Container>
</PageLayout>
